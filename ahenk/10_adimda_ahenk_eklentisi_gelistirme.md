##10 Adımda Ahenk Eklentisi Geliştirme

1. Ahenk geliştirme ortamını ve bağımlılıklarını kurun. [Bu dokümandaki](https://github.com/Agem-Bilisim/lider-ahenk-docs/blob/master/ahenk/ahenk_gelistirme_ortami_kurulumu.md) adımları izleyerek bağımlılıkları kurabilir, projeyi çalışır hale getirebilirsiniz.
2. [**lider-ahenk-archetype**](https://github.com/Pardus-Kurumsal/lider-ahenk-archetype) üzerinden yeni plugin için projeleri [bu dokümanda](https://github.com/Pardus-Kurumsal/lider-ahenk-archetype) belirtildiği gibi oluşturun.
3. Lider Ahenk'te archetype aracılığı ile yeni bir plugin projesi oluşturduğumuzda bu proje pluginimizin lider,console ve ahenk kısımlarını aynı dizin yapısı altında barındırır. Lider ve Console ile ilgili kısımları geliştirdiğimiz projeler maven modulü veya projesi iken, Ahenk kısmı debian paket yapısına uygun bir script dizinidir. Ahenk uygulaması çalışmaya başladığında `/etc/ahenk/ahenk.conf` dosyasında belirtilmiş olan,([**ahenk.conf** dosyasında hangi parametre ne işe yarar?](https://github.com/Agem-Bilisim/lider-ahenk-docs/blob/master/ahenk/sss.md)) eklentilerin bulunduğu dizin yolu bilgisine erişir. Eklentilerin bu dizinde olması beklenir. Eklentinin tüm bileşenleri yeni oluşturduğumuz eklenti klasöründeyken, ahenk-eklenti kısmını oluşturan dizini projeden dışarıya çıkarmamak için **ahenk.conf** dosyasında belirtilen eklentilerin yoluna ahenk-eklenti klasörü için soft link vermemiz işimizi kolaylaştıracaktır. Bunun için:
3.1 `/etc/ahenk/ahenk.conf` dosyasında **pluginfolderpath** parametresinde `/opt/ahenk/plugins/` yolunun olduğunu varsayalım
3.2  Yeni oluşturduğumuz eklentinin adının **sample**, bu eklentinin ahenk kısmının yolunun da `/home/user/git/lider-ahenk-sample-plugin/ahenk-sample/sample` olduğunu varsayalım.
3.3 `/home/user/git/lider-ahenk-sample-plugin/ahenk-sample/sample` dizinini `/opt/ahenk/plugins/` dizini içine link vermemiz için çalıştırmamız gereken terminal kodu şöyledir:
`ln -s /home/user/git/lider-ahenk-sample-plugin/ahenk-sample/sample /opt/ahenk/plugins/sample`
4. Eklentimizin Console ve Lider kısımlarını tamamlayıp Console'a ve Karaf'a eklentilerimizi eklediysek task veya policy'ler çalıştırıldığında, gönderilen datalar artık eklentinin ilgili py dosyasının handle fonksiyonlarına gelmesi gerekmektedir.
5. **sample** adlı eklentimizde bulunması gereken py dosyaları şunlardır:</br> **main.py** </br> **policy.py** </br> **command-id.py** </br> **safe.py** 
6. **policy.py** politika çalıştıran eklentilerde bulunması gerekir. Güncel profiller **login** işlemi sonrasında alınır ve ilgili eklentinin **policy.py** dosyasındaki **handle_policy** fonksiyonu Ahenk çekirdeği tarafından çağırılır ve bu fonksiyon **profile_data** ve **context** diye iki argüman alır.
7. **command_id.py** görev çalıştıran eklentilerde olmalıdır. Bu script'in adı Lider'de tanımlanan **command id** ile aynı olmak **zorundadır**. Lider'de tanımlı command id'ye  **sample** eklentisi için **lider-sample** projesi **tr.org.liderahenk.sample.commands** paketi içinde tanımlanmış class'larda **getCommandId()** metodunda static olarak tanımlanmış halde bulabilirsiniz. Burada dikkat edilmesi gereken noktalar: bir eklentinin birden fazla görevi olabilir. Bu amaçla **tr.org.liderahenk.sample.commands** paketi altında birden fazla class ve command id tanımlanmış olabilir. Buna paralel olarak tanımlanan her command id için  ahenk eklentisinde de command id isimleriyle py scriptleri oluştrmanız gerekir. Böylece aynı eklenti üzerinden gönderilen her farklı görev, ahenk eklentisinde farklı command id isimleriyle oluşturulmuş scriptlerce karşılanır.Bu scriptler dışardan **handle_task** fonksiyonu ile çalıştırılır ve bu fonksiyon **task** ve **context** diye iki argüman alır.
8. **safe.py** politika ya da görev çalıştırdıktan sonra çeşitli işlemler gerçekleştirilen makine üzerinde, oturum kapatılırken geri almak istenilen bir yapılandırma ayarı, silinmesi gereken bir dosya ya da eski haline getirilmek istenen herhangi bir durum için **safe.py** kullanılmalıdır.
9. Yukarda değinilen handle_policy ve handle_task fonksiyonlarının aldığı parametreleri açıklamak gerekirse: **context** ahenk çekirdeği ile veri alışverişini sağlar. Şimdilik ahenk tarafından eklentiye, kullanıcı adı göndermek; eklenti tarafından çekirdeğe, çalıştırılan görev ya da profilin sonucunun-datanın döndürülmesi için kullanılır. Örneğin `context.get('username')` ile eklenti kullanıcı adına erişebilir. `context.create_response(*args)` ile işlemin çalışma sonucunun (başarılı ya da başarısız olması gibi) döndürülmesi sağlanır.
**task ve profile_data** bu iki argümanda benzer işleve sahiptir. **task** görev çalıştırılırken gönderilen verilerin **profile_data** ise çalıştırılmak istenen profil bilgilerinin **json** formatındaki halidir. Console tarafından gönderilen veriler bu argümanlarla json formatında eklentiye ulaşır. Burdan sonra sadece gelen veriyi parse edip gerekli işlemleri gerçekleştimek kalıyor.
10. Archetype ile generate edilen eklentinin ahenk kısmındaki politika ve görevleri karşılayan scriptler AbstractPlugin class'ını extend ederler. </br>**AbstractPlugin** sayesinde ahenk çekirdeğinin sağladığı bazı sevis ve özelliklere erişebilir. Örneğin `self.get_logger()` gibi... </br>Aynı zamanda AbstractPlugin üzerinden temel python operasyonlarının kolaylıkla gerçekleştirilmesi için **Util** kullanılabilir. Util'i kullanmak için AbstractPlugin'i extend etmek yeterlidir. Util'i kullanarak temel dosya işlemleri başta olmak üzere terminal komutlarını çalıştırmak gibi işlemler kolaylıkla gerçekleştirilebilir. Örneğin  `self.execute('ls')`. İncelemek için [Util](https://github.com/Pardus-Kurumsal/ahenk/blob/master/opt/ahenk/base/util/util.py)'e bakılabilir.</br> Ahenk'in üzerinde çalıştığı makinenin temel sistem bilgilerine direk erişebilmek için AbstractPlugin üzerinden **System**'i kullanabiliriz. Örneğin: `self.Hardware.Network.interfaces()` ile network arayüzlerine erişilebilir. İncelemek için [System](https://github.com/Pardus-Kurumsal/ahenk/blob/master/opt/ahenk/base/system/system.py)'e bakılabilir.

**Not:** Eklenti geliştirdikten sonra **BeniOku**, **Kullanıcı** ve **Geliştirici** için ayrı dokümanlar oluşturun. </br>**BeniOku**'da eklenti hakkında kısaca temel bilgiler verilmeli. Bu bilgiler eklentinin politika veya görev çalıştırabilirliği, görev çalıştırıyorsa kaç farklı görev çalıştırdığı; kişi mi makine tabanlı mı olduğu , herhangi bir bileşene ya da mimariye bağımlı olup olmadığı; herhangi bir paket gereksinimi var olup olmadığı gibi bilgiler barındırmalı.</br>**Kullanıcı** dokümanında eklentinin ne işe yaradığı; hangi durumlarda nasıl kullanılacağı ekran görüntüleriyle desteklenerek açıklanmalıdır.</br>**Geliştirici** dokümanı için eklentinin kullandığı altyapı ve izlediği işleyiş, kullanılan harici bileşen-teknolojiler ve yöntemlerden bahsedilebilir.


